# 基于iOS平台蓝牙通信的小车控制

## 摘要
本项目通过改造遥控小车的控制电路与单片机程序，配合开发iOS平台上的控制程序，实现了在iOS平台上利用蓝牙技术遥控小车。
### 关键字: 单片机 串口通讯 iOS应用程序 iOS蓝牙技术 BTStack

## 项目总览
### 背景

智能手机近两年以不可思议的速度在消费电子市场攻城略地，亲民的价格与强大功能无疑是这股趋势的发动机。当这块屏幕渐渐成为大多数人了解世界的第三只眼睛，以及与世界交互的窗口时，我们站在技术的荒原上，理应对于科技有更高的执念。亦即探索科技的边界，探索工具最多能实现怎样不可思议的任务。

科技创新实践课在我的本科求学生涯中一直扮演一个非常重要的角色。在我大一懵懂无知的时候，这门课程就用一辆支离破碎的小车拖着我的小手，闯入了光怪陆离的电子信息世界。  

本项目再一次给我们提供了一个绝好的机会，从实践的角度去探索手机可以实现怎样的任务，去理解一些耳熟能详，却又不那么清晰的技术。比如单片机，比如蓝牙，比如串口通信，比如移动开发。本项目的完成，也为我们继续研究短距离无线通信的应用打下了基础。

### 项目任务
1. 改造遥控小车，使之能够接收iOS移动设备通过蓝牙技术传过来的控制信号，并根据控制信号作出相应的移动。
2. 在iOS移动设备上开发一个直观易用的遥控应用。

## 设计思路
### 遥控小车改装
遥控小车的改装主要有三种思路：  

1. 自制小车的机械结构和控制、逻辑、通讯、供电电路。
2. 保留遥控小车的机械结构，改造其逻辑和通讯电路。
3. 保留遥控小车的全部元件，改造其遥控器。

从思路1到思路3难度是逐渐降低的，但思路2和思路3实现难度的区别不大，甚至更加直接。综合考虑之后，我们选择思路2。

### iOS控制程序
为了充分发掘和展示移动设备在人机交互方面无与伦比的直观性，我们从触屏，陀螺仪，多点触控等角度对iOS控制程序作出了如下几种设计：

1. 虚拟按键。也就是少年们比较熟悉的手柄（d-pad或joypad），只不过方向按键变成了触屏上的按钮，凹凸感也只能用仿真贴图来作出阴影效果，聊做追忆。
2. 重力感应控制。将设备本身的空间座标映射到对小车的控制上。
3. 手势控制。用多个手指在屏幕上的张和（官方术语为pinch，即“捏“的意思，已经成为人机交互的典范用例）来表示小车的速度，用两只手指在屏幕上的相对角度来表示小车的方向。

在熟悉的领域，我们更愿意肩负起应有的责任。于是上述三种操作方式我们逐一实现了。


## 小车改装与单片机

## iOS控制程序
### iOS开发总览
iOS是由苹果公司开发的移动操作系统。最初是设计给iPhone使用，后来使用范围逐渐拓宽到iPod touch、iPad以及Apple TV等产品上。就像其基于的Mac OS X操作系统一样，它也是以Darwin为基础的。而Darwin则是一套基于UNIX的分发版，事实上对于越狱后开启了OpenSSH服务的iOS设备，我们可以用putty等虚拟终端设备登录。登录之后就会发现那就是一台标准的UNIX终端。  
但是由于iOS系统有层级结构，在PC上编译好一个UNIX程序传到设备上，是不能直接在手机上运行的。应用必须基建于iOS的SDK才可以在SpringBoard（按了HOME键之后那个界面其实也是一个应用）上显示图标，并在CocoaTouch层上运行。  
iOS的开发环境与OSX的开发环境相同，主要介绍四个方面：硬件，语言，框架，IDE。  

1. **硬件**。最基本的要求是一台Intel核心的苹果电脑（包括Mac Mini，MacBook，iMac等），和一台越狱之后的iOS设备（包括iPod Touch、iPhone、iPad等）。当然，绕过苹果电脑的方法（可以搜索「黑苹果」）也是存在的，但是折腾度与稳定性都让这种办法没有实用价值。还要注意的一点是iOS设备基本都是ARMv6或者ARMv7处理器，若用非官方工具链开发，要注意交叉编译的问题。
2. **语言**。主要用到的是Objective-C，简单的说就是加入了面向对象支持的C语言的超集。事实上其对C语言的扩展远远不限于面向对象，在开发中经常使用到的新特性包括「反射」、「闭包」、「ARC」、「动态性」等等。
3. **框架**。iOS将对不同功能的支持函数分别封装到了不同的框架里。比如在用到改进过的列表或字典类时，需要在头文件包含「Foundation Framework」；在用到UI控件的时候，需要在头文件包含「UIKit Framework」。这些封装了底层实现，为开发提供了极大便利的各式框架，其实是学习iOS开发过程中最大的难点。毕竟要记住的术语很多。
4. **IDE**。苹果公司提供了开发软件XCode的免费下载（当然只有OSX版本的），XCode是一整套IDE，包括编辑器，调试器，性能检测等。这一套东西看上去很繁杂，但是常用功能就几个，学习成本并不高。

最后对硬件部分做一些补充。要想在将开发中的应用放到移动设备上调试，必须先缴纳$99，加入苹果公司的「iOS Developer Program」。取得一份Profile，用这份电子Profile给应用签名，才能让应用在移动设备上运行。否则只能够在计算机上的iOS模拟器里运行，而模拟器是没办法模拟陀螺仪、蓝牙等特殊功能的。但同学们记住一句祖宗的话，道高一尺魔高一丈。绕过的办法是有的，详情请参见[Theos](http://iphonedevwiki.net/index.php/Theos)。

### iOS平台对蓝牙模块的限制
### BTStack
### Limo类的设计
### 控制器的设计
首先介绍遥控小车对信号的处理方式。小车端接受到一个信号——比如“左转”，其实表示的是小车的运动状态变为持续性的左转，而不是左转一下。  
指出这一点的原因在于，这种信号处理方式简化了控制器的逻辑，直接影响了控制器的设计方式。
### 开发中遇到的问题

## 总结
## 致谢











